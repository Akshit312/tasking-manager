machine:
  python:
    version: 3.6.1
  services:
    - postgres
  environment:
    TM_DB: postgresql://ubuntu:@127.0.0.1:5432/tm3
  pre:
    - |
      # Add a password to the `ubuntu` user, since Postgres is configured to
      # always ask for a password without sudo, and fails without one.
      sudo -u postgres psql -p 5433 -c "create user ubuntu with password 'ubuntu';"
      sudo -u postgres psql -p 5433 -c "alter user ubuntu with superuser;"
      # Create a new test database.
      sudo -u postgres psql -p 5433 -c "create database test;"

dependencies:
  cache_directories:
    # relative to the build directory
    - "client/node_modules"
    - "env"
  pre:
    - |
      # Install latest LTS node
      sudo apt-get update
      curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
      sudo apt-get install nodejs libgeos-c1 libgeos-dev # Required for shapely
      node --version
  override:
    - |
      # Install NPM packages and build client from gulpfile
      cd client
      npm install
      ./node_modules/.bin/gulp build
      cd ..
      # Install Python dependencies
      virtualenv env
      env/bin/pip install --upgrade pip
      env/bin/pip install -r requirements.txt

test:
  override:
    - |
      # JS Unit Tests
      cd tests/client
      ../../client/node_modules/.bin/karma start ./karma.conf.js \
        --single-run --browsers PhantomJS --reporters junit
    - |
      # Run Python tests
      env/bin/nosetests ./tests/server --with-xunit \
        --xunit-file $CIRCLE_TEST_REPORTS/unitresults.xml \
        --with-coverage --cover-erase --cover-package=./server
      env/bin/coverage xml -o $CIRCLE_TEST_REPORTS/coverage.xml
    - |
      # Run migrations
      env/bin/python manage.py db upgrade
  post:
    - |
      chmod +x ./devops/ci/circleci_deploy.sh
      ./devops/ci/circleci_deploy.sh
